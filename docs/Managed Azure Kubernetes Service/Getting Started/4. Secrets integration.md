## Overview
This guide walks you through setting up the CSI Secret Driver for Azure, allowing Kubernetes to use secrets stored in Azure Key Vault using a user-assigned managed identity.

### Prerequisites
- Installed Azure Kubernetes by Fortytwo
- Access to Keyvault
- Connected to AKS Cluster in CLI

### CSI Secret Store Driver configuration

1. **Access Your Key Vault**
   - In your managed resource group (eg. mrg-kubernetes-by-fortytwo if you are using the default values). Locate the Keyvault resource type in the resource list and click it. 

2. **Update IAM Settings**
   - Go to [Access control (IAM)](https://docs.microsoft.com/en-us/azure/key-vault/general/rbac-guide) section of your Key Vault.
   - Assign yourself the 'Key Vault Secrets Officer' role to manage secrets.
   - Click the "Select members" button and find your own user in the list.
   - Click Next and then "Review + assign" to save the changes.

3. **Add your IP address to the Key Vault firewall**
   - Find your own IP address (eg. by using https://whatismyipaddress.com/) and copy it to your clipboard.
   - Go to the "Networking" section in the left menu under "Settings".
   - Under "Firewall" click "+ Add your client IP address"
   - Paste in your IP address in the list and click "Save" to apply the changes.

4. **Add Secrets to Key Vault**
   - Navigate to the [Secrets](https://docs.microsoft.com/en-us/azure/key-vault/secrets/about-secrets) section in your Key Vault.
   - Click on **+ Generate/Import** to add new secrets.
   - Fill in the details for your secret and click **Create**.

5. **Configure Kubernetes to Use Azure Key Vault with User-Assigned Managed Identity**
   - Copy and paste the following code in your terminal, which utilizes a user-assigned managed identity to access your Key Vault. Replace `<key-vault-name>`, `<tenant-id>`, and `<client-id>` with your own values.

    ```yaml
    kubectl apply -f - <<EOF
    apiVersion: secrets-store.csi.x-k8s.io/v1
    kind: SecretProviderClass
    metadata:
      name: azure-kvname-user-msi
    spec:
      provider: azure
      parameters:
        usePodIdentity: "false"
        useVMManagedIdentity: "true"
        userAssignedIdentityID: <managed-identity-client-id>   # Replace with the clientID of the managed identity
        keyvaultName: <keyvault-name>                          # Replace with your Key Vault name
        objects:  |
          array:
            - |
              objectName: secret1
              objectType: secret
              objectVersion: ""
        tenantId: <tenant-id>                                 # Replace with your Azure tenant ID
    EOF
    ```
    - **Finding Tenant ID**:
      - In your Keyvault, click the "Overview" and look for the "Directory ID" in the "Essentials" section.
    - **Finding Managed Identity**:
      - The managed identity client-id can be found in the Azure portal under the resource type "Managed Identity". Its name typically follows the format `azurekeyvaultsecretsprovider-{cluster-name}`.

    - Apply your manifest by running the following command in your CLI:

        `kubectl apply -f secretproviderclass.yaml`

### Conclusion
After following these steps, the CSI Secret Driver will be configured in your Kubernetes cluster using Azure Key Vault with a user-assigned managed identity.

### Next steps

- [Upload your secrets to Azure keyvault](./5.%20Upload%20secrets.md)